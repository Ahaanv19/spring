<!DOCTYPE HTML>
<html xmlns:layout="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"
      layout:decorate="~{layouts/base}" lang="en">
<head>
    <title>Student GitHub Profile</title>
    <style>
        #details-container {
            display: flex;
            align-items: center;
            gap: 20px;
            background-color: #3a3a3a;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            max-width: 700px;
        }

        #profile-pic {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 2px solid #ddd;
        }

        .details-content {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .details-content a {
            color: #b0d4ff;
            text-decoration: none;
        }

        .details-content p {
            margin: 2px 0;
            font-size: 16px;
        }
    </style>
</head>
<body layout:fragment="body">

<div id="details-container">
    <!-- Populate some static fields using Thymeleaf -->
    <img id="profile-pic" th:src="${githubData != null} ? ${githubData.avatarUrl} : '/path/to/default-avatar.png'"
         alt="Profile Picture">
    <div class="details-content">
        <p><strong>Username:</strong> 
            <span id="githubUsername" th:text="${githubData != null} ? ${githubData.username} : 'N/A'"></span>
        </p>
        <p><strong>Profile URL:</strong> 
            <a id="githubProfile" th:href="${githubData != null} ? ${githubData.profileUrl} : '#'" 
               target="_blank" th:text="${githubData != null} ? ${githubData.profileUrl} : 'N/A'"></a>
        </p>
        <p><strong>Issues:</strong> <span id="githubIssues"></span></p>
        <p><strong>Pull Requests:</strong> <span id="githubPulls"></span></p>
        <p><strong>Commits:</strong> <span id="githubCommits"></span></p>
        <p><strong>Public Repos:</strong> 
            <span id="githubRepos" th:text="${githubData != null} ? ${githubData.publicRepos} : 'N/A'"></span>
        </p>
        <p><strong>Public Gists:</strong> 
            <span id="githubGists" th:text="${githubData != null} ? ${githubData.publicGists} : 'N/A'"></span>
        </p>
        <p><strong>Followers:</strong> 
            <span id="githubFollowers" th:text="${githubData != null} ? ${githubData.followers} : 'N/A'"></span>
        </p>
    </div>
</div>

<script type="module">
    async function fetchStudentDetails() {
        const urlParams = new URLSearchParams(window.location.search);
        const username = urlParams.get("username");
        const course = urlParams.get("course");
        const trimester = urlParams.get("trimester");
        const period = urlParams.get("period");

        const criteriaDto = {
            username: username,
            course: course,
            trimester: parseInt(trimester),
            period: parseInt(period)
        };

        try {
            // Fetch student data from backend
            const studentResponse = await fetch(`/api/students/find`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(criteriaDto)
            });

            if (!studentResponse.ok) throw new Error("Student not found");

            const student = await studentResponse.json();
            const githubUsername = student.username;

            // Fetch GitHub user profile
            const githubResponse = await fetch(`https://api.github.com/users/${githubUsername}`);
            if (!githubResponse.ok) throw new Error("GitHub profile not found");
            const githubData = await githubResponse.json();

            // Fetch GitHub user events for issues, PRs, and commits data
            const eventsResponse = await fetch(`https://api.github.com/users/${githubUsername}/events`);
            if (!eventsResponse.ok) throw new Error("GitHub events not found");
            const eventsData = await eventsResponse.json();

            // Define the start date for filtering events
            const startDate = new Date("2024-08-01T00:00:00Z");

            // Count events occurring after the start date
            const commitsCount = eventsData.filter(event => 
                event.type === "PushEvent" && new Date(event.created_at) >= startDate
            ).length;

            const prsCount = eventsData.filter(event => 
                event.type === "PullRequestEvent" && new Date(event.created_at) >= startDate
            ).length;

            const issuesCount = eventsData.filter(event => 
                event.type === "IssuesEvent" && new Date(event.created_at) >= startDate
            ).length;

            // Populate the dynamic fields
            document.getElementById("profile-pic").src = githubData.avatar_url;
            document.getElementById("githubUsername").innerText = githubData.login;
            document.getElementById("githubProfile").href = githubData.html_url;
            document.getElementById("githubProfile").innerText = githubData.html_url;
            document.getElementById("githubRepos").innerText = githubData.public_repos;
            document.getElementById("githubGists").innerText = githubData.public_gists;
            document.getElementById("githubFollowers").innerText = githubData.followers;

            document.getElementById("githubIssues").innerText = issuesCount;
            document.getElementById("githubPulls").innerText = prsCount;
            document.getElementById("githubCommits").innerText = commitsCount;

        } catch (error) {
            console.error("Error:", error);
            alert(error.message);
        }
    }

    window.onload = fetchStudentDetails;
</script>

</body>
</html>